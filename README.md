# üèóÔ∏è Azure Infrastructure as Code - NoteServe Project

This repository contains Terraform configurations for provisioning Azure infrastructure for the NoteServe application. The infrastructure includes networking, compute, storage, and monitoring resources with proper security and VNet integration.

## üìã Table of Contents

- [Architecture Overview](#architecture-overview)
- [Prerequisites](#prerequisites)
- [Quick Start](#quick-start)
- [Module Documentation](#module-documentation)
- [Variables Reference](#variables-reference)
- [Outputs Reference](#outputs-reference)
- [Deployment](#deployment)
- [Security Considerations](#security-considerations)
- [Best Practices](#best-practices)

## üèõÔ∏è Architecture Overview

The infrastructure is designed with a modular approach and includes:

### Core Infrastructure
- **Resource Group**: Centralized resource management
- **Virtual Network**: Multi-subnet architecture with NAT Gateway
- **Network Security**: Service endpoints and network rules

### Compute Resources
- **App Service**: Backend API with VNet integration
- **Container App**: Reporting application
- **Static Web App**: Frontend application

### Data & Storage
- **SQL Server**: Managed database with authentication
- **Storage Account**: Blob storage with network rules
- **Key Vault**: Secrets management with network access

### Monitoring & Observability
- **Application Insights**: Application monitoring
- **Log Analytics**: Centralized logging workspace
- **Managed Identity**: Secure authentication

### Network Architecture
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Virtual Network                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ   App       ‚îÇ ‚îÇ   DB        ‚îÇ ‚îÇ   Build     ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  Subnet     ‚îÇ ‚îÇ  Subnet     ‚îÇ ‚îÇ  Subnet     ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ (10.10.1.0)‚îÇ ‚îÇ(10.10.2.0)  ‚îÇ ‚îÇ(10.10.3.0)  ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ           VNet Integration Subnet                 ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ              (10.10.4.0/27)                      ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîß Prerequisites

### Required Tools
- [Terraform](https://www.terraform.io/downloads.html) >= 1.0
- [Azure CLI](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli)
- [Azure DevOps](https://azure.microsoft.com/en-us/services/devops/) (for CI/CD)

### Azure Requirements
- Active Azure Subscription
- Service Principal with appropriate permissions
- Azure DevOps Environment configured

### Required Permissions
- **Contributor** role on the target subscription
- **Key Vault Administrator** role (for Key Vault operations)
- **SQL Server Contributor** role (for SQL Server operations)

## üöÄ Quick Start

### 1. Clone Repository
```bash
git clone <repository-url>
cd noteserve_iac_provisioner
```

### 2. Configure Environment Variables
```bash
export ARM_CLIENT_ID="your-service-principal-id"
export ARM_CLIENT_SECRET="your-service-principal-secret"
export ARM_SUBSCRIPTION_ID="your-subscription-id"
export ARM_TENANT_ID="your-tenant-id"
```

### 3. Initialize Terraform
```bash
terraform init
```

### 4. Configure Variables
Copy and modify the environment-specific variables:
```bash
cp env/test.tfvars env/your-environment.tfvars
# Edit the variables file with your values
```

### 5. Plan and Apply
```bash
terraform plan -var-file="env/your-environment.tfvars"
terraform apply -var-file="env/your-environment.tfvars"
```

## üì¶ Module Documentation

### üîß Provider Configuration

**Type**: `provider`  
**Source**: `hashicorp/azurerm`  
**Version**: `~> 4.35.0`  
**Purpose**: Azure Resource Manager provider configuration

#### Authentication
- **Method**: Service Principal via environment variables
- **Variables**: `ARM_CLIENT_ID`, `ARM_CLIENT_SECRET`, `ARM_SUBSCRIPTION_ID`, `ARM_TENANT_ID`

### üè¢ Resource Group Module

**Type**: `module`  
**Source**: `./modules/resource_group`  
**Purpose**: Centralized resource management and organization

#### Attributes

| Name | Type | Description | Default | Required |
|------|------|-------------|---------|----------|
| `env_prefix` | `string` | Environment prefix for naming | - | ‚úÖ |
| `company_name` | `string` | Company name for resource naming | - | ‚úÖ |
| `location` | `string` | Azure region for resources | - | ‚úÖ |
| `tags` | `map(string)` | Resource tags | `{}` | ‚ùå |

### üåê Virtual Network Module

**Type**: `module`  
**Source**: `./modules/vnet`  
**Purpose**: Network infrastructure with multiple subnets

#### Attributes

| Name | Type | Description | Default | Required |
|------|------|-------------|---------|----------|
| `env_prefix` | `string` | Environment prefix | - | ‚úÖ |
| `company_name` | `string` | Company name | - | ‚úÖ |
| `location` | `string` | Azure region | - | ‚úÖ |
| `address_space` | `list(string)` | VNet address space | - | ‚úÖ |
| `resource_group_name` | `string` | Resource group name | - | ‚úÖ |
| `tags` | `map(string)` | Resource tags | `{}` | ‚ùå |

### üîó Subnet Modules

**Type**: `module`  
**Source**: `./modules/subnet`  
**Purpose**: Network segmentation with service endpoints and delegations

#### Subnet Types

1. **App Subnet** (`subnet_app`)
   - **Purpose**: Network rules for Storage Account and Key Vault
   - **Features**: Service endpoints, App Service delegation, NAT Gateway
   - **Address Range**: `10.10.1.0/24`

2. **VNet Integration Subnet** (`subnet_vnet_integration`)
   - **Purpose**: App Service VNet integration
   - **Features**: Service endpoints, App Service delegation, NAT Gateway
   - **Address Range**: `10.10.4.0/27`

3. **DB Subnet** (`subnet_db`)
   - **Purpose**: Database services
   - **Features**: Service endpoints, NAT Gateway
   - **Address Range**: `10.10.2.0/27`

4. **Build Subnet** (`subnet_build`)
   - **Purpose**: Build/deployment services
   - **Features**: Service endpoints, NAT Gateway
   - **Address Range**: `10.10.3.0/27`

### üö™ NAT Gateway Module

**Type**: `module`  
**Source**: `./modules/nat_gateway`  
**Purpose**: Outbound internet connectivity and traffic whitelisting

#### Features
- **Outbound Connectivity**: All subnets route through NAT Gateway
- **IP Whitelisting**: Single public IP for external services
- **Security**: Controlled outbound traffic

### üíæ Storage Account Module

**Type**: `module`  
**Source**: `./modules/storage_account`  
**Purpose**: Blob storage with network security

#### Security Features
- **Network Rules**: Restrict access to specific subnets
- **Service Endpoints**: Direct connectivity to Azure services
- **Default Action**: Deny public access

### üåê App Service Module

**Type**: `module`  
**Source**: `./modules/app_service`  
**Purpose**: Backend API with VNet integration and network access control

#### Features
- **VNet Integration**: Connected to dedicated subnet
- **Network Access Control**: IP restrictions for specific subnets
- **Public Access**: Enabled with controlled access
- **Outbound Routing**: Through NAT Gateway

#### Network Configuration
- **Public Network Access**: Enabled
- **IP Restrictions**: Allow DB and Build subnets
- **Default Action**: Deny unmatched traffic

### üîê Key Vault Module

**Type**: `module`  
**Source**: `./modules/key_vault`  
**Purpose**: Secrets management with network security

#### Security Features
- **Network Rules**: Restrict access to App subnet
- **Service Endpoints**: Direct connectivity
- **Default Action**: Deny public access

### üìä Monitoring Modules

#### Log Analytics Module
**Type**: `module`  
**Source**: `./modules/log_analytics`  
**Purpose**: Centralized logging workspace

#### Application Insights Module
**Type**: `module`  
**Source**: `./modules/application_insights`  
**Purpose**: Application performance monitoring

### üóÑÔ∏è SQL Server Module

**Type**: `module`  
**Source**: `./modules/sql_server`  
**Purpose**: Managed database with authentication

#### Security Features
- **Authentication**: SQL Server authentication
- **Managed Identity**: For secure access to Key Vault
- **Network Security**: Through VNet integration

### üê≥ Container App Module

**Type**: `module`  
**Source**: `./modules/container_app`  
**Purpose**: Reporting application deployment

#### Features
- **Container Registry**: Azure Container Registry support
- **Scaling**: Min/max replicas configuration
- **Environment Variables**: Configurable app settings

### üé® Static Web App Module

**Type**: `module`  
**Source**: `./modules/static_web_app`  
**Purpose**: Frontend application hosting

#### Features
- **Global Distribution**: CDN-enabled hosting
- **Application Insights**: Performance monitoring
- **Custom Domain**: Support for custom domains

### üîë Managed Identity Module

**Type**: `module`  
**Source**: `./modules/managed_identity`  
**Purpose**: Secure authentication for Azure services

#### Features
- **SQL Server Access**: Database authentication
- **Key Vault Access**: Secrets retrieval
- **Zero Secrets**: No credentials in code

## üìù Variables Reference

### Core Variables

| Name | Type | Description | Default | Required |
|------|------|-------------|---------|----------|
| `env_prefix` | `string` | Environment prefix (dev, test, prod) | - | ‚úÖ |
| `company_name` | `string` | Company name for resource naming | - | ‚úÖ |
| `location` | `string` | Azure region for deployment | - | ‚úÖ |
| `tags` | `map(string)` | Resource tags | - | ‚úÖ |

### Network Variables

| Name | Type | Description | Default | Required |
|------|------|-------------|---------|----------|
| `vnet_address_space` | `list(string)` | VNet address space | - | ‚úÖ |
| `app_subnet_prefix` | `string` | App subnet CIDR | - | ‚úÖ |
| `db_subnet_prefix` | `string` | DB subnet CIDR | - | ‚úÖ |
| `build_subnet_prefix` | `string` | Build subnet CIDR | - | ‚úÖ |

### Storage Variables

| Name | Type | Description | Default | Required |
|------|------|-------------|---------|----------|
| `storage_account_name` | `string` | Storage account name | - | ‚úÖ |

### Compute Variables

| Name | Type | Description | Default | Required |
|------|------|-------------|---------|----------|
| `app_service_plan_sku` | `string` | App Service Plan SKU | - | ‚úÖ |
| `key_vault_sku` | `string` | Key Vault SKU | - | ‚úÖ |
| `static_web_app_sku` | `string` | Static Web App SKU | - | ‚úÖ |

### Database Variables

| Name | Type | Description | Default | Required |
|------|------|-------------|---------|----------|
| `sql_admin_username` | `string` | SQL Server admin username | - | ‚úÖ |
| `sql_admin_password` | `string` | SQL Server admin password | - | ‚úÖ |
| `sql_database_name` | `string` | Database name | `"noteserve_db"` | ‚ùå |
| `sql_sku_name` | `string` | Database SKU | `"S2"` | ‚ùå |
| `sql_max_size_gb` | `number` | Database max size | `2` | ‚ùå |

### Container App Variables

| Name | Type | Description | Default | Required |
|------|------|-------------|---------|----------|
| `container_image` | `string` | Container image | `"mcr.microsoft.com/azuredocs/containerapps-helloworld:latest"` | ‚ùå |
| `container_image_version` | `string` | Image version | `"latest"` | ‚ùå |
| `container_cpu` | `number` | CPU allocation | `0.5` | ‚ùå |
| `container_memory` | `string` | Memory allocation | `"1Gi"` | ‚ùå |
| `container_target_port` | `number` | Target port | `80` | ‚ùå |
| `container_min_replicas` | `number` | Min replicas | `0` | ‚ùå |
| `container_max_replicas` | `number` | Max replicas | `3` | ‚ùå |

### Monitoring Variables

| Name | Type | Description | Default | Required |
|------|------|-------------|---------|----------|
| `log_analytics_workspace_sku` | `string` | Log Analytics SKU | - | ‚úÖ |
| `app_insights_type` | `string` | Application Insights type | - | ‚úÖ |
| `tenant_id` | `string` | Azure tenant ID | - | ‚úÖ |

## üì§ Outputs Reference

| Name | Type | Description | Sensitive |
|------|------|-------------|-----------|
| `vnet_name` | `string` | Virtual Network name | ‚ùå |
| `app_subnet_name` | `string` | App subnet name | ‚ùå |
| `db_subnet_name` | `string` | DB subnet name | ‚ùå |
| `build_subnet_name` | `string` | Build subnet name | ‚ùå |
| `storage_account_name` | `string` | Storage account name | ‚ùå |
| `backend_url` | `string` | App Service URL | ‚ùå |
| `key_vault_name` | `string` | Key Vault name | ‚ùå |
| `log_analytics_workspace_id` | `string` | Log Analytics workspace ID | ‚ùå |
| `app_insights_connection_string` | `string` | Application Insights connection string | ‚úÖ |
| `frontend_url` | `string` | Static Web App URL | ‚ùå |
| `reporting_app_url` | `string` | Container App URL | ‚ùå |
| `reporting_app_fqdn` | `string` | Container App FQDN | ‚ùå |

## üöÄ Deployment

### Azure DevOps Pipeline

The project includes an Azure DevOps pipeline (`azure-pipelines.yml`) that:

1. **Plan Stage**: Validates and plans Terraform changes
2. **Apply Stage**: Applies changes with approval gates
3. **Authentication**: Uses Service Principal authentication
4. **Environment**: Supports multiple environments

### Manual Deployment

```bash
# Initialize Terraform
terraform init

# Plan deployment
terraform plan -var-file="env/test.tfvars"

# Apply changes
terraform apply -var-file="env/test.tfvars"

# Destroy infrastructure (if needed)
terraform destroy -var-file="env/test.tfvars"
```

### Environment-Specific Deployment

```bash
# Development
terraform apply -var-file="env/dev.tfvars"

# Testing
terraform apply -var-file="env/test.tfvars"

# Production
terraform apply -var-file="env/prod.tfvars"
```

## üîí Security Considerations

### Network Security
- ‚úÖ **Private Subnets**: All resources in private subnets
- ‚úÖ **Service Endpoints**: Direct connectivity to Azure services
- ‚úÖ **Network Rules**: Restrict access to specific subnets
- ‚úÖ **NAT Gateway**: Controlled outbound traffic

### Authentication & Authorization
- ‚úÖ **Managed Identity**: Zero-secret authentication
- ‚úÖ **Service Principal**: Pipeline authentication
- ‚úÖ **Key Vault**: Secure secrets management
- ‚úÖ **SQL Authentication**: Database access control

### Data Protection
- ‚úÖ **Encryption at Rest**: All storage encrypted
- ‚úÖ **Encryption in Transit**: TLS for all connections
- ‚úÖ **Network Isolation**: VNet-based security

## üìã Best Practices

### ‚úÖ Implemented Best Practices

1. **Modular Design**: Reusable modules for each resource type
2. **Consistent Naming**: Standardized naming convention
3. **Resource Tagging**: Comprehensive tagging strategy
4. **Network Security**: Private subnets with controlled access
5. **Monitoring**: Application Insights and Log Analytics
6. **Secrets Management**: Key Vault integration
7. **CI/CD**: Automated deployment pipeline

### ‚ö†Ô∏è Recommendations

1. **Backend Configuration**: Use Azure Storage for Terraform state
2. **Environment Separation**: Separate state files per environment
3. **Cost Optimization**: Monitor and optimize resource usage
4. **Disaster Recovery**: Implement backup and recovery procedures
5. **Compliance**: Regular security audits and compliance checks

## üîó Useful Links

- [Azure Provider Documentation](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs)
- [Terraform Best Practices](https://www.terraform-best-practices.com/)
- [Azure Architecture Center](https://docs.microsoft.com/en-us/azure/architecture/)
- [Azure Security Best Practices](https://docs.microsoft.com/en-us/azure/security/)

## ü§ù Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Test thoroughly
5. Submit a pull request

## üìÑ License

This project is licensed under the MIT License - see the LICENSE file for details.

---

**Note**: This infrastructure is designed for production use with proper security measures. Always review and test changes in a non-production environment first.
